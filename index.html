<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>Unity WebGL</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            background: #000;
            overflow: hidden;
        }

        :root { --vh: 100dvh; }

        #unity-container {
            position: fixed;
            inset: 0;
            padding: env(safe-area-inset-top) env(safe-area-inset-right)
            env(safe-area-inset-bottom) env(safe-area-inset-left);
            display: grid;
            place-items: center;
            background: #000;
        }

        #unity-canvas {
            width: 100vw;
            height: var(--vh);
            display: block;
            touch-action: none;
        }

        /* --- Splash Screen + Loading Bar --- */
        #splash {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
            background: #0b0b0b;
            z-index: 10;
            transition: opacity 0.4s ease;
        }

        #splash.hidden { opacity: 0; pointer-events: none; }

        #splash .logo {
            width: min(42vw, 220px);
            height: auto;
            image-rendering: auto;
            filter: drop-shadow(0 6px 18px rgba(255,255,255,0.08));
        }

        #bar {
            width: min(64vw, 420px);
            height: 10px;
            border-radius: 999px;
            background: #2a2a2a;
            overflow: hidden;
        }

        #bar > i {
            display: block;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffb36b, #ff6aa3);
            transition: width 0.12s linear;
        }

        #pct {
            font: 500 12px/1.2 ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
            color: #d8d8d8;
            opacity: 0.9;
        }

        #log {
            position: fixed;
            left: 8px;
            bottom: 8px;
            color: #f55;
            font: 12px/1.4 monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
<!-- Splash with logo + loading bar -->
<div id="splash">
    <img class="logo" src="TemplateData/logo.png" alt="Logo"/>
    <div id="bar"><i id="fill"></i></div>
    <div id="pct">0%</div>
</div>

<!-- Unity canvas -->
<div id="unity-container">
    <canvas id="unity-canvas" tabindex="0"></canvas>
</div>
<pre id="log"></pre>

<script>
    // --- Fix viewport height on mobile browsers ---
    function setVHVar() {
        const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
        document.documentElement.style.setProperty('--vh', vh + 'px');
    }
    setVHVar();
    window.addEventListener('resize', setVHVar);
    window.visualViewport && window.visualViewport.addEventListener('resize', setVHVar);

    // === Project build name ===
    const BUILD_NAME = "AvatarBuilder"; // Example: your Unity project name

    const buildUrl = "Build";
    const loaderUrl = `${buildUrl}/${BUILD_NAME}.loader.js`;

    const config = {
        dataUrl:       `${buildUrl}/${BUILD_NAME}.data.unityweb`,
        frameworkUrl:  `${buildUrl}/${BUILD_NAME}.framework.js.unityweb`,
        codeUrl:       `${buildUrl}/${BUILD_NAME}.wasm.unityweb`,
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Company",
        productName: BUILD_NAME,
        productVersion: "1.0",
        matchWebGLToCanvasSize: true,
        devicePixelRatio: Math.min(window.devicePixelRatio || 1, 1.5),
    };

    const canvas = document.getElementById("unity-canvas");
    const splash = document.getElementById("splash");
    const fill   = document.getElementById("fill");
    const pctEl  = document.getElementById("pct");
    const logEl  = document.getElementById("log");

    const log = (m) => { logEl.textContent += m + "\n"; console.warn(m); };

    // --- Pre-flight file existence check ---
    function head(url) {
        return fetch(url, { method: "HEAD" })
            .then(r => { if (!r.ok) throw new Error(`${url} â†’ ${r.status}`); });
    }

    Promise.all([
        head(loaderUrl),
        head(config.dataUrl),
        head(config.frameworkUrl),
        head(config.codeUrl),
    ])
        .then(() => {
            const script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                if (typeof createUnityInstance !== "function") {
                    log("Loader loaded but createUnityInstance is undefined.");
                    return;
                }

                createUnityInstance(canvas, config, (progress) => {
                    const p = Math.floor(progress * 100);
                    fill.style.width = p + "%";
                    pctEl.textContent = p + "%";
                }).then((inst) => {
                    // Hide splash when loading completes
                    setTimeout(() => splash.classList.add('hidden'), 300);
                    // Optional fullscreen on first tap
                    window.addEventListener('pointerdown', function once() {
                        if (!document.fullscreenElement)
                            (canvas.requestFullscreen || canvas.webkitRequestFullscreen)?.call(canvas);
                        window.removeEventListener('pointerdown', once);
                    }, { passive: true, once: true });
                }).catch(e => log("Unity init error: " + e));
            };
            script.onerror = () => log("Failed to load loader: " + loaderUrl);
            document.body.appendChild(script);
        })
        .catch(e => log("Missing or blocked build file: " + e.message));
</script>
</body>
</html>
